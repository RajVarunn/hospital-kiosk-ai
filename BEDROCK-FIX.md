# Fixing Bedrock Integration

Follow these steps to fix the Bedrock integration in your hospital kiosk AI application:

## 1. Update AWS SDK Dependencies

1. Install AWS SDK v2 alongside v3:
   ```bash
   npm install aws-sdk
   ```

## 2. Update Your AWS Credentials

1. Create a `.env` file in your Lambda function directory:
   ```
   AWS_REGION=us-west-2
   AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY
   AWS_SECRET_ACCESS_KEY=YOUR_SECRET_KEY
   ```

2. Replace `YOUR_ACCESS_KEY` and `YOUR_SECRET_KEY` with your actual AWS credentials.

## 3. Test Bedrock Access

1. Update the credentials in `test-bedrock.js` with your actual AWS credentials.

2. Run the test script:
   ```bash
   node test-bedrock.js
   ```

3. If successful, you should see a response from Claude.

## 4. Update Your Lambda Function

1. Replace your current `bedrockTest` function in `index.mjs` with the one from `updated-bedrock-function.js`.

2. Update the credentials in the function with your actual AWS credentials.

## 5. Update IAM Permissions

1. Go to the AWS Management Console
2. Navigate to IAM > Roles
3. Find your Lambda function's role
4. Click "Add permissions" > "Create inline policy"
5. Choose the JSON tab and paste this policy:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "bedrock:InvokeModel",
           "bedrock:InvokeModelWithResponseStream"
         ],
         "Resource": "*"
       }
     ]
   }
   ```
6. Name it "BedrockInvokePolicy" and create it

## 6. Enable Bedrock Model Access

1. Go to Amazon Bedrock > Model access
2. Request access to the Claude models if not already enabled
3. Wait for approval (usually quick)

## 7. Deploy Your Lambda Function

1. Zip your updated code:
   ```bash
   zip -r function.zip index.mjs node_modules package.json
   ```

2. Update your Lambda function:
   ```bash
   aws lambda update-function-code --function-name your-function-name --zip-file fileb://function.zip
   ```

## 8. Test the Health Assessment

1. Use the "Test Bedrock API" button in your frontend
2. Check the Lambda logs in CloudWatch for any errors
3. If successful, you should see a health assessment generated by Bedrock

## Common Issues and Solutions

### "User is not authorized to perform: bedrock:InvokeModel"
- Make sure you've added the BedrockInvokePolicy to your Lambda role
- Verify that your AWS credentials have permission to use Bedrock

### "Cannot find module 'aws-sdk'"
- Make sure you've installed the aws-sdk package
- Check that it's included in your deployment package

### "Model not found"
- Verify that you have access to the Claude model in Bedrock
- Try using a different model like "anthropic.claude-v2"

### "Invalid request syntax"
- Check that your request format matches the model's requirements
- Claude 2 uses a different format than Claude 3